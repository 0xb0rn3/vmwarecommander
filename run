#!/usr/bin/env bash

################################################################################
# Tool Name: vmwarecommander
# Developer: oxbv1 | 0xb0rn3
# Version:   1.0
# Description: Fully automated VMware setup & persistent kernel hook for Arch
################################################################################

# Ensure the script runs as root
if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root (sudo vmwarecommander)"
   exit 1
fi

set -e

# Colors for terminal output
G='\033[0;32m' # Green
B='\033[0;34m' # Blue
R='\033[0;31m' # Red
NC='\033[0m'   # No Color

echo -e "${B}########################################################${NC}"
echo -e "${B}#             VMWARE COMMANDER v1.0                    #${NC}"
echo -e "${B}#             Developed by: oxbv1 | 0xb0rn3            #${NC}"
echo -e "${B}########################################################${NC}"

# 1. Detect Kernel and Install Headers
echo -e "\n${G}[*] Detecting kernel and installing headers...${NC}"
KERNEL_VER=$(uname -r)
if [[ "$KERNEL_VER" == *"lts"* ]]; then
    HDR_PKG="linux-lts-headers"
else
    HDR_PKG="linux-headers"
fi
pacman -Syu --needed --noconfirm base-devel "$HDR_PKG" dkms libxcrypt-compat libxml2 git

# 2. Automated AUR Dependency Handling
install_aur_pkg() {
    local PKG=$1
    if ! pacman -Qi "$PKG" &> /dev/null; then
        echo -e "${G}[*] Building AUR dependency: $PKG...${NC}"
        # We must drop privileges to run makepkg
        local USER_HOME=$(eval echo "~$SUDO_USER")
        cd /tmp
        sudo -u "$SUDO_USER" git clone "https://aur.archlinux.org/$PKG.git"
        cd "$PKG"
        sudo -u "$SUDO_USER" makepkg -si --noconfirm
        cd ..
        rm -rf "$PKG"
    else
        echo -e "${G}[+] $PKG already installed.${NC}"
    fi
}

install_aur_pkg "vmware-keymaps"
install_aur_pkg "libxml2-legacy"
install_aur_pkg "vmware-workstation"

# 3. Create the Persistent Pacman Hook
# This ensures dkms autoinstall runs EVERY time the kernel is updated
echo -e "${G}[*] Creating persistent Pacman Hook...${NC}"
mkdir -p /etc/pacman.d/hooks
cat <<EOF > /etc/pacman.d/hooks/90-vmware-dkms.hook
[Trigger]
Operation = Install
Operation = Upgrade
Target = linux
Target = linux-lts
Target = linux-zen
Target = vmware-workstation

[Action]
Description = [vmwarecommander] Rebuilding VMware Kernel Modules...
When = PostTransaction
Exec = /usr/bin/dkms autoinstall
EOF

# 4. Service Initialization
echo -e "${G}[*] Enabling and starting VMware services...${NC}"
systemctl enable --now vmware-networks.service
systemctl enable --now vmware-usbarbitrator.service
systemctl enable --now vmware-hostd.service

# 5. Load Modules for Current Session
echo -e "${G}[*] Loading kernel modules for current session...${NC}"
modprobe -a vmw_vmci vmmon

echo -e "\n${B}Success! vmwarecommander has finished the setup.${NC}"
echo -e "${B}The Pacman hook is active. Updates will be handled automatically.${NC}\n"
