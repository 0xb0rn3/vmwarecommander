#!/usr/bin/env bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
NC='\033[0m'

LOG_FILE="/tmp/vmwarecommander-$(date +%s).log"

echo -e "${BLUE}"
cat << "EOF"
╦  ╦╔╦╗╦ ╦╔═╗╦═╗╔═╗  ╔═╗╔═╗╔╦╗╔╦╗╔═╗╔╗╔╔╦╗╔═╗╦═╗
╚╗╔╝║║║║║║╠═╣╠╦╝║╣   ║  ║ ║║║║║║║╠═╣║║║ ║║║╣ ╠╦╝
 ╚╝ ╩ ╩╚╩╝╩ ╩╩╚═╚═╝  ╚═╝╚═╝╩ ╩╩ ╩╩ ╩╝╚╝═╩╝╚═╝╩╚═
EOF
echo -e "${NC}"
echo -e "${CYAN}v2.0.0 | 0xb0rn3 | oxbv1${NC}"
echo -e "${GRAY}Arch Linux VMware Installer${NC}\n"

if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}✗ Run with sudo${NC}"
   exit 1
fi

spinner() {
    local pid=$1
    local msg=$2
    local spin='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
    local i=0
    
    while kill -0 $pid 2>/dev/null; do
        i=$(( (i+1) %10 ))
        printf "\r${CYAN}${spin:$i:1}${NC} ${msg}"
        sleep 0.1
    done
    printf "\r"
}

step() {
    echo -e "${BLUE}[$1/6]${NC} $2"
}

success() {
    echo -e "      ${GREEN}✓${NC} $1"
}

fail() {
    echo -e "      ${RED}✗${NC} $1"
}

warn() {
    echo -e "      ${YELLOW}⚠${NC} $1"
}

exec 3>&1 4>&2
exec 1>>"$LOG_FILE" 2>&1

ACTUAL_USER=${SUDO_USER:-$USER}
USER_HOME=$(eval echo "~$ACTUAL_USER")

if [[ -z "$ACTUAL_USER" ]] || [[ "$ACTUAL_USER" == "root" ]]; then
    fail "Cannot determine non-root user" >&3
    exec 1>&3 2>&4
    exit 1
fi

echo -e "${BLUE}[*]${NC} Checking prerequisites" >&3
{
    ping -c 1 8.8.8.8
} &> /dev/null

if [ $? -eq 0 ]; then
    success "Internet connection active" >&3
else
    fail "No internet connection" >&3
    exec 1>&3 2>&4
    exit 1
fi

if [[ ! -f /etc/arch-release ]]; then
    fail "This script is for Arch-based distributions only" >&3
    exec 1>&3 2>&4
    exit 1
fi

success "Distribution: Arch Linux" >&3

KERNEL_VER=$(uname -r)
success "Kernel: $KERNEL_VER" >&3

step "1" "Checking for existing VMware installation" >&3
if command -v vmware &> /dev/null; then
    warn "VMware already installed" >&3
    read -p "$(echo -e "      ${YELLOW}Continue anyway? (y/N):${NC} ")" -n 1 -r >&3
    echo >&3
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exec 1>&3 2>&4
        exit 0
    fi
else
    success "No existing installation" >&3
fi

step "2" "Installing base dependencies" >&3
{
    pacman -Sy --needed --noconfirm \
        base-devel \
        linux-headers \
        dkms \
        git \
        fuse2 \
        gtkmm3 \
        libcanberra \
        pcsclite \
        gcc \
        make
} &
spinner $! "Installing base dependencies" >&3
wait $!

if [ $? -eq 0 ]; then
    success "Base dependencies installed" >&3
else
    fail "Failed to install dependencies" >&3
    exec 1>&3 2>&4
    exit 1
fi

detect_aur_helper() {
    for helper in yay paru; do
        if sudo -u "$ACTUAL_USER" command -v $helper &> /dev/null; then
            AUR_HELPER=$helper
            return 0
        fi
    done
    return 1
}

step "3" "Setting up AUR helper" >&3
if detect_aur_helper; then
    success "Found AUR helper: $AUR_HELPER" >&3
    TEMP_AUR_HELPER=false
else
    warn "No AUR helper found, installing yay" >&3
    
    {
        BUILD_DIR="${USER_HOME}/.cache/yay-install"
        sudo -u "$ACTUAL_USER" rm -rf "$BUILD_DIR"
        sudo -u "$ACTUAL_USER" mkdir -p "$BUILD_DIR"
        cd "$BUILD_DIR"
        
        sudo -u "$ACTUAL_USER" git clone https://aur.archlinux.org/yay.git .
        sudo -u "$ACTUAL_USER" makepkg -si --noconfirm
        
        cd /
        sudo -u "$ACTUAL_USER" rm -rf "$BUILD_DIR"
    } &
    
    spinner $! "Building yay from AUR" >&3
    wait $!
    
    if [ $? -eq 0 ]; then
        AUR_HELPER="yay"
        TEMP_AUR_HELPER=true
        success "yay installed" >&3
    else
        fail "Failed to install yay" >&3
        exec 1>&3 2>&4
        exit 1
    fi
fi

step "4" "Installing VMware packages from AUR" >&3

{
    sudo -u "$ACTUAL_USER" $AUR_HELPER -S --needed --noconfirm --removemake vmware-keymaps
} &
spinner $! "Building vmware-keymaps" >&3
wait $!

if [ $? -eq 0 ]; then
    success "vmware-keymaps installed" >&3
else
    fail "Failed to install vmware-keymaps" >&3
    exec 1>&3 2>&4
    exit 1
fi

{
    sudo -u "$ACTUAL_USER" $AUR_HELPER -S --needed --noconfirm --removemake vmware-workstation
} &
spinner $! "Building vmware-workstation (this may take a while)" >&3
wait $!

if [ $? -eq 0 ]; then
    success "vmware-workstation installed" >&3
else
    fail "Failed to install vmware-workstation" >&3
    exec 1>&3 2>&4
    exit 1
fi

if [[ "$TEMP_AUR_HELPER" == "true" ]]; then
    read -p "$(echo -e "      ${YELLOW}Keep yay for future use? (Y/n):${NC} ")" -n 1 -r >&3
    echo >&3
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        pacman -Rns --noconfirm yay &>> "$LOG_FILE"
        success "yay removed" >&3
    else
        success "yay kept for future use" >&3
    fi
fi

step "5" "Configuring VMware services" >&3

{
    systemctl daemon-reload
    
    for service in vmware-networks vmware-usbarbitrator vmware-hostd; do
        if systemctl list-unit-files | grep -q "${service}.service"; then
            systemctl enable ${service}.service
            systemctl start ${service}.service
        fi
    done
} &
spinner $! "Enabling VMware services" >&3
wait $!
success "VMware services configured" >&3

step "6" "Loading VMware kernel modules" >&3

MODULES_LOADED=0
for module in vmw_vmci vmmon vmnet; do
    if modprobe $module 2>/dev/null; then
        ((MODULES_LOADED++))
    fi
done

if [[ $MODULES_LOADED -gt 0 ]]; then
    success "Loaded $MODULES_LOADED kernel modules" >&3
else
    warn "Modules will load after reboot" >&3
fi

mkdir -p /etc/pacman.d/hooks

cat > /etc/pacman.d/hooks/90-vmware-dkms.hook << 'HOOKEOF'
[Trigger]
Operation = Install
Operation = Upgrade
Type = Package
Target = linux
Target = linux-lts
Target = linux-zen
Target = linux-hardened
Target = vmware-workstation

[Action]
Description = Rebuilding VMware kernel modules
When = PostTransaction
Exec = /usr/bin/dkms autoinstall
HOOKEOF

success "Auto-rebuild hook installed" >&3

exec 1>&3 2>&4

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}[*]${NC} Installation verification"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

ERRORS=0
WARNINGS=0

for module in vmmon vmw_vmci vmnet; do
    if lsmod | grep -q "^$module" 2>/dev/null; then
        success "$module kernel module loaded"
    else
        warn "$module not loaded (reboot may be required)"
        ((WARNINGS++))
    fi
done

if command -v vmware &> /dev/null; then
    success "VMware binary: $(which vmware)"
else
    fail "VMware binary not found"
    ((ERRORS++))
fi

if pacman -Qi vmware-keymaps &> /dev/null; then
    success "vmware-keymaps installed"
else
    fail "vmware-keymaps not installed"
    ((ERRORS++))
fi

if pacman -Qi vmware-workstation &> /dev/null; then
    success "vmware-workstation installed"
else
    fail "vmware-workstation not installed"
    ((ERRORS++))
fi

for service in vmware-networks vmware-usbarbitrator; do
    if systemctl is-enabled --quiet ${service}.service 2>/dev/null; then
        if systemctl is-active --quiet ${service}.service 2>/dev/null; then
            success "${service}.service enabled and running"
        else
            warn "${service}.service enabled but not running"
            ((WARNINGS++))
        fi
    fi
done

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

if [[ $ERRORS -eq 0 ]]; then
    echo -e "\n${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✓ VMware Workstation installation complete${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    
    if [[ $WARNINGS -gt 0 ]]; then
        echo -e "\n${YELLOW}Note: $WARNINGS warning(s) detected${NC}"
        echo -e "${YELLOW}Run 'sudo reboot' for all changes to take effect${NC}"
    fi
    
    echo -e "\n${CYAN}Launch VMware:${NC} vmware"
    echo -e "${CYAN}Command line:${NC} vmware &"
    echo -e "${CYAN}Auto-rebuild:${NC} Modules rebuild on kernel updates"
    echo -e "${CYAN}Full logs:${NC} $LOG_FILE"
else
    echo -e "\n${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}Installation completed with $ERRORS error(s), $WARNINGS warning(s)${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "\n${YELLOW}Troubleshooting:${NC}"
    echo -e "  ${GRAY}Check modules:${NC} lsmod | grep vm"
    echo -e "  ${GRAY}Load modules:${NC} sudo modprobe vmmon vmw_vmci vmnet"
    echo -e "  ${GRAY}Check services:${NC} systemctl status vmware-networks"
    echo -e "  ${GRAY}Full logs:${NC} $LOG_FILE"
    echo -e "\n${YELLOW}Manual installation:${NC}"
    echo -e "  ${GRAY}yay -S vmware-keymaps vmware-workstation${NC}"
fi

echo ""
