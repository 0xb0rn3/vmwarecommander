#!/usr/bin/env bash

################################################################################
# vmwarecommander
# Version: 0.0.1
# Developer: 0xb0rn3 | oxbv1
# 
# Automates VMware Workstation installation on Arch Linux
# Handles kernel detection, dependencies, and automatic DKMS rebuilds
################################################################################

# Exit on any error
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Banner
echo -e "${BLUE}"
cat << "EOF"
╦  ╦╔╦╗╦ ╦╔═╗╦═╗╔═╗  ╔═╗╔═╗╔╦╗╔╦╗╔═╗╔╗╔╔╦╗╔═╗╦═╗
╚╗╔╝║║║║║║╠═╣╠╦╝║╣   ║  ║ ║║║║║║║╠═╣║║║ ║║║╣ ╠╦╝
 ╚╝ ╩ ╩╚╩╝╩ ╩╩╚═╚═╝  ╚═╝╚═╝╩ ╩╩ ╩╩ ╩╝╚╝═╩╝╚═╝╩╚═
EOF
echo -e "${NC}"
echo -e "${YELLOW}v0.0.1 | 0xb0rn3 | oxbv1${NC}\n"

# Root check
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}[!] Run this script with sudo${NC}"
   exit 1
fi

# Detect the actual user (not root)
ACTUAL_USER=${SUDO_USER:-$USER}
USER_HOME=$(eval echo "~$ACTUAL_USER")

echo -e "${GREEN}[*] Starting VMware Workstation setup${NC}\n"

# Step 1: Kernel detection
echo -e "${BLUE}[1/7]${NC} Detecting kernel type"
KERNEL_VER=$(uname -r)
if [[ "$KERNEL_VER" == *"lts"* ]]; then
    HEADERS_PKG="linux-lts-headers"
    echo -e "      Kernel: LTS (${KERNEL_VER})"
else
    HEADERS_PKG="linux-headers"
    echo -e "      Kernel: Standard (${KERNEL_VER})"
fi

# Step 2: System update and base dependencies
echo -e "\n${BLUE}[2/7]${NC} Installing base dependencies"
pacman -Syu --needed --noconfirm \
    base-devel \
    "$HEADERS_PKG" \
    dkms \
    libxcrypt-compat \
    libxml2 \
    git

# Step 3: AUR package builder function
build_aur_package() {
    local PKG_NAME=$1
    
    if pacman -Qi "$PKG_NAME" &> /dev/null; then
        echo -e "      ${PKG_NAME} is already installed"
        return 0
    fi
    
    echo -e "      Building ${PKG_NAME} from AUR"
    
    local BUILD_DIR="/tmp/aur-${PKG_NAME}-$$"
    mkdir -p "$BUILD_DIR"
    cd "$BUILD_DIR"
    
    sudo -u "$ACTUAL_USER" git clone "https://aur.archlinux.org/${PKG_NAME}.git" .
    sudo -u "$ACTUAL_USER" makepkg -si --noconfirm
    
    cd /
    rm -rf "$BUILD_DIR"
}

# Step 4: Build AUR dependencies
echo -e "\n${BLUE}[3/7]${NC} Building AUR packages"
build_aur_package "vmware-keymaps"
build_aur_package "vmware-workstation"

# Step 5: Pacman hook creation
echo -e "\n${BLUE}[4/7]${NC} Creating Pacman hook for automatic DKMS rebuilds"
mkdir -p /etc/pacman.d/hooks

cat > /etc/pacman.d/hooks/90-vmware-dkms.hook << 'HOOKEOF'
[Trigger]
Operation = Install
Operation = Upgrade
Target = linux
Target = linux-lts
Target = linux-zen
Target = linux-hardened
Target = vmware-workstation

[Action]
Description = Rebuilding VMware kernel modules
When = PostTransaction
Exec = /usr/bin/dkms autoinstall
HOOKEOF

echo -e "      Hook installed at /etc/pacman.d/hooks/90-vmware-dkms.hook"

# Step 6: Service configuration
echo -e "\n${BLUE}[5/7]${NC} Configuring VMware services"
systemctl enable --now vmware-networks.service 2>/dev/null || true
systemctl enable --now vmware-usbarbitrator.service 2>/dev/null || true

# Step 7: Load kernel modules
echo -e "\n${BLUE}[6/7]${NC} Loading VMware kernel modules"
modprobe -a vmw_vmci vmmon

# Step 8: Verification
echo -e "\n${BLUE}[7/7]${NC} Verifying installation"
if lsmod | grep -q "vmmon"; then
    echo -e "      ${GREEN}✓${NC} vmmon loaded"
else
    echo -e "      ${RED}✗${NC} vmmon not loaded"
fi

if lsmod | grep -q "vmw_vmci"; then
    echo -e "      ${GREEN}✓${NC} vmw_vmci loaded"
else
    echo -e "      ${RED}✗${NC} vmw_vmci not loaded"
fi

if systemctl is-active --quiet vmware-networks.service; then
    echo -e "      ${GREEN}✓${NC} vmware-networks.service active"
else
    echo -e "      ${YELLOW}⚠${NC} vmware-networks.service inactive"
fi

if systemctl is-active --quiet vmware-usbarbitrator.service; then
    echo -e "      ${GREEN}✓${NC} vmware-usbarbitrator.service active"
else
    echo -e "      ${YELLOW}⚠${NC} vmware-usbarbitrator.service inactive"
fi

# Completion
echo -e "\n${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}VMware Workstation setup complete${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "\n${BLUE}Launch VMware:${NC} vmware"
echo -e "${BLUE}Note:${NC} The Pacman hook will rebuild modules automatically on kernel updates\n"
