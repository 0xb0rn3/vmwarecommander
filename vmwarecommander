#!/usr/bin/env bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
NC='\033[0m'

LOG_FILE="/tmp/vmwarecommander-$(date +%s).log"

echo -e "${BLUE}"
cat << "EOF"
╦  ╦╔╦╗╦ ╦╔═╗╦═╗╔═╗  ╔═╗╔═╗╔╦╗╔╦╗╔═╗╔╗╔╔╦╗╔═╗╦═╗
╚╗╔╝║║║║║║╠═╣╠╦╝║╣   ║  ║ ║║║║║║║╠═╣║║║ ║║║╣ ╠╦╝
 ╚╝ ╩ ╩╚╩╝╩ ╩╩╚═╚═╝  ╚═╝╚═╝╩ ╩╩ ╩╩ ╩╝╚╝═╩╝╚═╝╩╚═
EOF
echo -e "${NC}"
echo -e "${CYAN}v1.1.0 | 0xb0rn3 | oxbv1${NC}"
echo -e "${GRAY}Universal Linux Installer${NC}\n"

if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}✗ Run with sudo${NC}"
   exit 1
fi

spinner() {
    local pid=$1
    local msg=$2
    local spin='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
    local i=0
    
    while kill -0 $pid 2>/dev/null; do
        i=$(( (i+1) %10 ))
        printf "\r${CYAN}${spin:$i:1}${NC} ${msg}"
        sleep 0.1
    done
    printf "\r"
}

step() {
    echo -e "${BLUE}[$1/8]${NC} $2"
}

success() {
    echo -e "      ${GREEN}✓${NC} $1"
}

fail() {
    echo -e "      ${RED}✗${NC} $1"
}

warn() {
    echo -e "      ${YELLOW}⚠${NC} $1"
}

exec 3>&1 4>&2
exec 1>>"$LOG_FILE" 2>&1

ACTUAL_USER=${SUDO_USER:-$USER}
USER_HOME=$(eval echo "~$ACTUAL_USER")

detect_distro() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        DISTRO=$ID
        DISTRO_FAMILY=$ID_LIKE
        DISTRO_VERSION=$VERSION_ID
    elif [[ -f /etc/arch-release ]]; then
        DISTRO="arch"
        DISTRO_FAMILY="arch"
    elif [[ -f /etc/debian_version ]]; then
        DISTRO="debian"
        DISTRO_FAMILY="debian"
    elif [[ -f /etc/redhat-release ]]; then
        DISTRO="rhel"
        DISTRO_FAMILY="rhel fedora"
    else
        fail "Unable to detect Linux distribution" >&3
        exit 1
    fi
    
    case "$DISTRO" in
        arch|manjaro|endeavouros|artix|archbang|garuda|arcolinux|cachyos|reborn|crystal)
            DISTRO_FAMILY="arch"
            ;;
        ubuntu|debian|mint|pop|elementary|zorin|kali|parrot|mx|deepin|peppermint|linuxmint)
            DISTRO_FAMILY="debian"
            ;;
        fedora|rhel|centos|rocky|almalinux|nobara|ultramarine)
            DISTRO_FAMILY="fedora"
            ;;
        opensuse*|sles|tumbleweed)
            DISTRO_FAMILY="suse"
            ;;
        void)
            DISTRO_FAMILY="void"
            ;;
        gentoo|funtoo)
            DISTRO_FAMILY="gentoo"
            ;;
        alpine)
            DISTRO_FAMILY="alpine"
            ;;
    esac
}

detect_aur_helper() {
    for helper in yay paru; do
        if command -v $helper &> /dev/null; then
            AUR_HELPER=$helper
            return 0
        fi
    done
    return 1
}

install_aur_helper() {
    {
        pacman -S --needed --noconfirm git base-devel
        
        BUILD_DIR="${USER_HOME}/.cache/yay-install"
        sudo -u "$ACTUAL_USER" mkdir -p "$BUILD_DIR"
        cd "$BUILD_DIR"
        
        sudo -u "$ACTUAL_USER" git clone https://aur.archlinux.org/yay.git .
        sudo -u "$ACTUAL_USER" makepkg -si --noconfirm
        
        cd /
        sudo -u "$ACTUAL_USER" rm -rf "$BUILD_DIR"
    } &
    
    spinner $! "Installing yay" >&3
    wait $!
    
    if [ $? -eq 0 ]; then
        AUR_HELPER="yay"
        TEMP_AUR_HELPER=true
        success "AUR helper installed" >&3
        return 0
    else
        fail "Failed to install yay" >&3
        return 1
    fi
}

build_aur_manual() {
    local PKG_NAME=$1
    
    if pacman -Qi "$PKG_NAME" &> /dev/null; then
        success "$PKG_NAME already installed" >&3
        return 0
    fi
    
    {
        BUILD_DIR="${USER_HOME}/.cache/aur-build/${PKG_NAME}"
        sudo -u "$ACTUAL_USER" rm -rf "$BUILD_DIR"
        sudo -u "$ACTUAL_USER" mkdir -p "$BUILD_DIR"
        
        cd "$BUILD_DIR"
        
        sudo -u "$ACTUAL_USER" git clone "https://aur.archlinux.org/${PKG_NAME}.git" . || exit 1
        
        [[ ! -f "PKGBUILD" ]] && exit 1
        
        sudo -u "$ACTUAL_USER" makepkg -si --noconfirm || exit 1
        
        cd /
        sudo -u "$ACTUAL_USER" rm -rf "$BUILD_DIR"
    } &
    
    spinner $! "Building $PKG_NAME from AUR" >&3
    wait $!
    
    if [ $? -eq 0 ]; then
        success "$PKG_NAME installed" >&3
        return 0
    else
        fail "Failed to build $PKG_NAME" >&3
        return 1
    fi
}

echo -e "${BLUE}[*]${NC} Checking prerequisites" >&3
{
    ping -c 1 8.8.8.8
} &> /dev/null

if [ $? -eq 0 ]; then
    success "Internet connection active" >&3
else
    fail "No internet connection" >&3
    exec 1>&3 2>&4
    exit 1
fi

detect_distro
success "Distribution: $DISTRO ($DISTRO_FAMILY)" >&3

step "1" "Detecting kernel type" >&3
KERNEL_VER=$(uname -r)
success "Kernel: $KERNEL_VER" >&3

step "2" "Checking for existing VMware installation" >&3
if command -v vmware &> /dev/null; then
    warn "VMware already installed" >&3
    read -p "$(echo -e "      ${YELLOW}Continue anyway? (y/N):${NC} ")" -n 1 -r >&3
    echo >&3
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exec 1>&3 2>&4
        exit 0
    fi
else
    success "No existing installation" >&3
fi

step "3" "Installing dependencies for $DISTRO_FAMILY" >&3

case "$DISTRO_FAMILY" in
    arch)
        {
            pacman -Sy --needed --noconfirm \
                base-devel \
                linux-headers \
                dkms \
                libxcrypt-compat \
                git \
                fuse2 \
                gtkmm3 \
                libcanberra \
                pcsclite \
                gcc \
                make
        } &
        spinner $! "Installing Arch dependencies" >&3
        wait $!
        
        if [ $? -eq 0 ]; then
            success "Dependencies installed" >&3
        else
            fail "Failed to install dependencies" >&3
            exec 1>&3 2>&4
            exit 1
        fi
        
        step "4" "Building AUR packages" >&3
        
        if detect_aur_helper; then
            success "Found AUR helper: $AUR_HELPER" >&3
            
            {
                sudo -u "$ACTUAL_USER" $AUR_HELPER -S --needed --noconfirm vmware-workstation
            } &
            spinner $! "Building vmware-workstation with $AUR_HELPER" >&3
            wait $!
            
            if [ $? -ne 0 ]; then
                warn "AUR helper failed, trying manual build" >&3
                build_aur_manual "vmware-workstation" || {
                    fail "Failed to install VMware Workstation" >&3
                    exec 1>&3 2>&4
                    exit 1
                }
            else
                success "vmware-workstation installed" >&3
            fi
        else
            warn "No AUR helper found" >&3
            install_aur_helper || {
                fail "Cannot proceed without AUR helper" >&3
                exec 1>&3 2>&4
                exit 1
            }
            
            {
                sudo -u "$ACTUAL_USER" $AUR_HELPER -S --needed --noconfirm vmware-workstation
            } &
            spinner $! "Building vmware-workstation with yay" >&3
            wait $!
            
            if [ $? -ne 0 ]; then
                warn "AUR helper failed, trying manual build" >&3
                build_aur_manual "vmware-workstation" || {
                    fail "Failed to install VMware Workstation" >&3
                    exec 1>&3 2>&4
                    exit 1
                }
            else
                success "vmware-workstation installed" >&3
            fi
            
            if [[ "$TEMP_AUR_HELPER" == "true" ]]; then
                read -p "$(echo -e "      ${YELLOW}Keep yay for future use? (y/N):${NC} ")" -n 1 -r >&3
                echo >&3
                if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                    pacman -Rns --noconfirm yay &>> "$LOG_FILE"
                    success "yay removed" >&3
                else
                    success "yay kept" >&3
                fi
            fi
        fi
        ;;
        
    debian)
        {
            apt-get update
            apt-get install -y \
                build-essential \
                linux-headers-$(uname -r) \
                dkms \
                git \
                gcc \
                make \
                perl \
                libfuse2 \
                libgtkmm-3.0-1v5 \
                libcanberra-gtk3-module \
                pcscd
        } &
        spinner $! "Installing Debian dependencies" >&3
        wait $!
        
        if [ $? -eq 0 ]; then
            success "Dependencies installed" >&3
        else
            fail "Failed to install dependencies" >&3
            exec 1>&3 2>&4
            exit 1
        fi
        
        MANUAL_INSTALL=true
        ;;
        
    fedora)
        PKG_MGR=$(command -v dnf &> /dev/null && echo "dnf" || echo "yum")
        
        {
            $PKG_MGR install -y \
                kernel-devel \
                kernel-headers \
                gcc \
                make \
                perl \
                dkms \
                git \
                fuse \
                gtkmm30 \
                libcanberra-gtk3 \
                pcsc-lite
        } &
        spinner $! "Installing Fedora dependencies" >&3
        wait $!
        
        if [ $? -eq 0 ]; then
            success "Dependencies installed" >&3
        else
            fail "Failed to install dependencies" >&3
            exec 1>&3 2>&4
            exit 1
        fi
        
        MANUAL_INSTALL=true
        ;;
        
    suse)
        {
            zypper install -y \
                kernel-devel \
                gcc \
                make \
                perl \
                dkms \
                git \
                fuse \
                gtkmm3 \
                libcanberra-gtk3-0 \
                pcsc-lite
        } &
        spinner $! "Installing openSUSE dependencies" >&3
        wait $!
        
        if [ $? -eq 0 ]; then
            success "Dependencies installed" >&3
        else
            fail "Failed to install dependencies" >&3
            exec 1>&3 2>&4
            exit 1
        fi
        
        MANUAL_INSTALL=true
        ;;
        
    void)
        {
            xbps-install -Syu \
                base-devel \
                linux-headers \
                dkms \
                git \
                gcc \
                make \
                fuse \
                gtk+3-devel
        } &
        spinner $! "Installing Void dependencies" >&3
        wait $!
        
        if [ $? -eq 0 ]; then
            success "Dependencies installed" >&3
        else
            fail "Failed to install dependencies" >&3
            exec 1>&3 2>&4
            exit 1
        fi
        
        MANUAL_INSTALL=true
        ;;
        
    *)
        fail "Unsupported distribution: $DISTRO_FAMILY" >&3
        exec 1>&3 2>&4
        exit 1
        ;;
esac

if [[ "$MANUAL_INSTALL" == "true" ]]; then
    step "4" "Downloading VMware Workstation" >&3
    
    VMWARE_BUNDLE=$(find /tmp ~/Downloads -name "VMware-Workstation-*.bundle" 2>/dev/null | head -n 1)
    
    if [[ -z "$VMWARE_BUNDLE" ]]; then
        warn "VMware bundle not found" >&3
        echo -e "      ${GRAY}Download: https://www.vmware.com/products/workstation-pro${NC}" >&3
        read -p "$(echo -e "      ${YELLOW}Path to bundle (or Enter to skip):${NC} ")" VMWARE_BUNDLE >&3
        
        if [[ -z "$VMWARE_BUNDLE" ]] || [[ ! -f "$VMWARE_BUNDLE" ]]; then
            warn "Skipping VMware installation" >&3
            SKIP_VMWARE_INSTALL=true
        fi
    fi
    
    if [[ "$SKIP_VMWARE_INSTALL" != "true" ]]; then
        success "Found: $(basename $VMWARE_BUNDLE)" >&3
        chmod +x "$VMWARE_BUNDLE" &>> "$LOG_FILE"
        
        {
            "$VMWARE_BUNDLE" --console --required --eulas-agreed
        } &
        spinner $! "Installing VMware Workstation" >&3
        wait $!
        
        if [ $? -eq 0 ]; then
            success "VMware installed" >&3
        else
            fail "VMware installation failed" >&3
            exec 1>&3 2>&4
            exit 1
        fi
    fi
fi

step "5" "Setting up automatic module rebuild" >&3

case "$DISTRO_FAMILY" in
    arch)
        mkdir -p /etc/pacman.d/hooks
        
        cat > /etc/pacman.d/hooks/90-vmware-dkms.hook << 'HOOKEOF'
[Trigger]
Operation = Install
Operation = Upgrade
Type = Package
Target = linux
Target = linux-lts
Target = linux-zen
Target = linux-hardened
Target = vmware-workstation

[Action]
Description = Rebuilding VMware kernel modules
When = PostTransaction
Exec = /usr/bin/dkms autoinstall
HOOKEOF
        success "Pacman hook installed" >&3
        ;;
        
    debian)
        mkdir -p /etc/apt/apt.conf.d
        cat > /etc/apt/apt.conf.d/99-vmware-dkms << 'APTEOF'
DPkg::Post-Invoke {
    "if [ -x /usr/sbin/dkms ]; then /usr/sbin/dkms autoinstall --kernelver $(uname -r) 2>/dev/null || true; fi";
};
APTEOF
        success "APT hook installed" >&3
        ;;
        
    fedora)
        mkdir -p /etc/dnf/plugins/post-transaction-actions.d
        cat > /etc/dnf/plugins/post-transaction-actions.d/vmware-dkms.action << 'DNFEOF'
kernel*:install,update:/usr/sbin/dkms autoinstall 2>/dev/null || true
DNFEOF
        success "DNF hook installed" >&3
        ;;
        
    suse)
        cat > /etc/systemd/system/vmware-dkms-rebuild.service << 'SYSDEOF'
[Unit]
Description=Rebuild VMware DKMS modules
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/usr/sbin/dkms autoinstall

[Install]
WantedBy=multi-user.target
SYSDEOF
        systemctl daemon-reload &>> "$LOG_FILE"
        success "Systemd service installed" >&3
        ;;
esac

if [[ "$SKIP_VMWARE_INSTALL" != "true" ]]; then
    step "6" "Building VMware kernel modules" >&3
    if command -v dkms &> /dev/null; then
        {
            dkms autoinstall
        } &
        spinner $! "Compiling kernel modules" >&3
        wait $!
        success "Modules built" >&3
    else
        warn "DKMS not available" >&3
    fi
    
    step "7" "Configuring VMware services" >&3
    VMWARE_SERVICES_DIR=""
    for dir in /usr/lib/systemd/system /lib/systemd/system /etc/systemd/system; do
        if [[ -d "$dir" ]] && ls "$dir"/vmware*.service &> /dev/null 2>&1; then
            VMWARE_SERVICES_DIR="$dir"
            break
        fi
    done

    if [[ -n "$VMWARE_SERVICES_DIR" ]]; then
        systemctl daemon-reload &>> "$LOG_FILE"
        
        SERVICES_ENABLED=0
        for service in vmware-networks vmware-usbarbitrator vmware-hostd; do
            if [[ -f "$VMWARE_SERVICES_DIR/${service}.service" ]]; then
                systemctl enable ${service}.service &>> "$LOG_FILE" || true
                systemctl start ${service}.service &>> "$LOG_FILE" || true
                ((SERVICES_ENABLED++))
            fi
        done
        success "$SERVICES_ENABLED services configured" >&3
    else
        warn "VMware services not found" >&3
    fi
    
    step "8" "Loading VMware kernel modules" >&3
    MODULES_LOADED=0
    for module in vmw_vmci vmmon vmnet; do
        if modprobe $module 2>/dev/null; then
            ((MODULES_LOADED++))
        fi
    done
    
    if [[ $MODULES_LOADED -gt 0 ]]; then
        success "Loaded $MODULES_LOADED modules" >&3
    else
        warn "Modules will load after reboot" >&3
    fi
else
    step "6" "Skipping DKMS build" >&3
    step "7" "Skipping service configuration" >&3
    step "8" "Skipping module loading" >&3
fi

exec 1>&3 2>&4

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}[*]${NC} Installation verification"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

ERRORS=0
WARNINGS=0

if [[ "$SKIP_VMWARE_INSTALL" != "true" ]]; then
    for module in vmmon vmw_vmci; do
        if lsmod | grep -q "$module" 2>/dev/null; then
            success "$module kernel module loaded"
        else
            warn "$module not loaded (reboot required)"
            ((WARNINGS++))
        fi
    done

    VMWARE_FOUND=false
    for path in /usr/bin/vmware /usr/local/bin/vmware; do
        if [[ -x "$path" ]]; then
            success "VMware binary: $path"
            VMWARE_FOUND=true
            break
        fi
    done

    if [[ "$VMWARE_FOUND" == "false" ]]; then
        fail "VMware binary not found"
        ((ERRORS++))
    fi
    
    for service in vmware-networks vmware-usbarbitrator; do
        if systemctl is-active --quiet ${service}.service 2>/dev/null; then
            success "${service}.service active"
        fi
    done
    
    if command -v dkms &> /dev/null; then
        if dkms status | grep -q vmware 2>/dev/null; then
            success "VMware DKMS modules registered"
        else
            warn "No DKMS modules found"
            ((WARNINGS++))
        fi
    fi
else
    warn "VMware installation was skipped"
fi

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

if [[ "$SKIP_VMWARE_INSTALL" == "true" ]]; then
    echo -e "\n${YELLOW}Setup complete - VMware installation skipped${NC}"
    if [[ "$DISTRO_FAMILY" == "arch" ]]; then
        echo -e "${GRAY}Install manually: yay -S vmware-workstation${NC}"
    else
        echo -e "${GRAY}Download from: https://www.vmware.com/products/workstation-pro${NC}"
        echo -e "${GRAY}Then run this script again${NC}"
    fi
elif [[ $ERRORS -eq 0 ]]; then
    echo -e "\n${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✓ VMware Workstation setup complete${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    
    if [[ $WARNINGS -gt 0 ]]; then
        echo -e "\n${YELLOW}Note: $WARNINGS warning(s) detected${NC}"
        echo -e "${YELLOW}Reboot recommended for all changes to take effect${NC}"
    fi
    
    echo -e "\n${CYAN}Launch VMware:${NC} vmware"
    echo -e "${CYAN}Auto-rebuild:${NC} Modules rebuild on kernel updates"
    echo -e "${CYAN}Full logs:${NC} $LOG_FILE"
else
    echo -e "\n${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}Setup completed with $ERRORS error(s), $WARNINGS warning(s)${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "\n${YELLOW}Troubleshooting:${NC}"
    echo -e "  ${GRAY}Check status:${NC} dkms status"
    echo -e "  ${GRAY}Load modules:${NC} sudo modprobe vmmon vmw_vmci"
    echo -e "  ${GRAY}Rebuild:${NC} sudo dkms autoinstall"
    echo -e "  ${GRAY}Full logs:${NC} $LOG_FILE"
fi

echo ""
