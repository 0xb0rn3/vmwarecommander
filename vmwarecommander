#!/usr/bin/env bash

################################################################################
# vmwarecommander
# Version: 1.1.0
# Developer: 0xb0rn3 | oxbv1
# 
# Automated VMware Workstation installation across Linux distributions
# Supports: Arch-based, Debian/Ubuntu, Fedora/RHEL, openSUSE, and derivatives
################################################################################

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}"
cat << "EOF"
╦  ╦╔╦╗╦ ╦╔═╗╦═╗╔═╗  ╔═╗╔═╗╔╦╗╔╦╗╔═╗╔╗╔╔╦╗╔═╗╦═╗
╚╗╔╝║║║║║║╠═╣╠╦╝║╣   ║  ║ ║║║║║║║╠═╣║║║ ║║║╣ ╠╦╝
 ╚╝ ╩ ╩╚╩╝╩ ╩╩╚═╚═╝  ╚═╝╚═╝╩ ╩╩ ╩╩ ╩╝╚╝═╩╝╚═╝╩╚═
EOF
echo -e "${NC}"
echo -e "${YELLOW}v1.1.0 | 0xb0rn3 | oxbv1${NC}"
echo -e "${YELLOW}Universal Linux Installer${NC}\n"

if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}[!] Run this script with sudo${NC}"
   exit 1
fi

ACTUAL_USER=${SUDO_USER:-$USER}
USER_HOME=$(eval echo "~$ACTUAL_USER")

detect_distro() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        DISTRO=$ID
        DISTRO_FAMILY=$ID_LIKE
        DISTRO_VERSION=$VERSION_ID
    elif [[ -f /etc/arch-release ]]; then
        DISTRO="arch"
        DISTRO_FAMILY="arch"
    elif [[ -f /etc/debian_version ]]; then
        DISTRO="debian"
        DISTRO_FAMILY="debian"
    elif [[ -f /etc/redhat-release ]]; then
        DISTRO="rhel"
        DISTRO_FAMILY="rhel fedora"
    else
        echo -e "${RED}[!] Unable to detect Linux distribution${NC}"
        exit 1
    fi
    
    case "$DISTRO" in
        arch|manjaro|endeavouros|artix|archbang|garuda|arcolinux|cachyos|reborn|crystal)
            DISTRO_FAMILY="arch"
            ;;
        ubuntu|debian|mint|pop|elementary|zorin|kali|parrot|mx|deepin|peppermint)
            DISTRO_FAMILY="debian"
            ;;
        fedora|rhel|centos|rocky|almalinux|nobara|ultramarine)
            DISTRO_FAMILY="fedora"
            ;;
        opensuse*|sles|tumbleweed)
            DISTRO_FAMILY="suse"
            ;;
        void)
            DISTRO_FAMILY="void"
            ;;
        gentoo|funtoo)
            DISTRO_FAMILY="gentoo"
            ;;
        alpine)
            DISTRO_FAMILY="alpine"
            ;;
    esac
}

detect_aur_helper() {
    for helper in yay paru; do
        if command -v $helper &> /dev/null; then
            AUR_HELPER=$helper
            return 0
        fi
    done
    return 1
}

install_aur_helper() {
    echo -e "${YELLOW}[!] No AUR helper found (yay/paru)${NC}"
    echo -e "    VMware Workstation requires AUR packages"
    read -p "    Install yay temporarily? (Y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        echo -e "      Installing yay..."
        
        pacman -S --needed --noconfirm git base-devel
        
        BUILD_DIR="${USER_HOME}/.cache/yay-install"
        sudo -u "$ACTUAL_USER" mkdir -p "$BUILD_DIR"
        cd "$BUILD_DIR"
        
        sudo -u "$ACTUAL_USER" git clone https://aur.archlinux.org/yay.git .
        sudo -u "$ACTUAL_USER" makepkg -si --noconfirm
        
        cd /
        sudo -u "$ACTUAL_USER" rm -rf "$BUILD_DIR"
        
        AUR_HELPER="yay"
        TEMP_AUR_HELPER=true
        echo -e "      ${GREEN}✓${NC} yay installed"
        return 0
    else
        echo -e "${RED}[!] Cannot proceed without AUR helper${NC}"
        exit 1
    fi
}

build_aur_manual() {
    local PKG_NAME=$1
    
    if pacman -Qi "$PKG_NAME" &> /dev/null; then
        echo -e "      ${GREEN}✓${NC} ${PKG_NAME} already installed"
        return 0
    fi
    
    echo -e "      Building ${PKG_NAME} from AUR (manual)"
    
    BUILD_DIR="${USER_HOME}/.cache/aur-build/${PKG_NAME}"
    sudo -u "$ACTUAL_USER" rm -rf "$BUILD_DIR"
    sudo -u "$ACTUAL_USER" mkdir -p "$BUILD_DIR"
    
    cd "$BUILD_DIR"
    
    if ! sudo -u "$ACTUAL_USER" git clone "https://aur.archlinux.org/${PKG_NAME}.git" . ; then
        echo -e "      ${RED}✗${NC} Failed to clone ${PKG_NAME}"
        cd /
        return 1
    fi
    
    if [[ ! -f "PKGBUILD" ]]; then
        echo -e "      ${RED}✗${NC} PKGBUILD not found"
        cd /
        return 1
    fi
    
    if ! sudo -u "$ACTUAL_USER" makepkg -si --noconfirm; then
        echo -e "      ${RED}✗${NC} Failed to build ${PKG_NAME}"
        cd /
        return 1
    fi
    
    cd /
    sudo -u "$ACTUAL_USER" rm -rf "$BUILD_DIR"
    echo -e "      ${GREEN}✓${NC} ${PKG_NAME} installed"
    return 0
}

echo -e "${BLUE}[*] Checking prerequisites${NC}"
if ! ping -c 1 8.8.8.8 &> /dev/null; then
    echo -e "${RED}[!] No internet connection${NC}"
    exit 1
fi
echo -e "      ${GREEN}✓${NC} Internet connection active"

detect_distro
echo -e "      ${GREEN}✓${NC} Distribution: $DISTRO ($DISTRO_FAMILY)"

echo -e "\n${GREEN}[*] Starting VMware Workstation setup${NC}\n"

echo -e "${BLUE}[1/8]${NC} Detecting kernel type"
KERNEL_VER=$(uname -r)
echo -e "      Kernel: ${KERNEL_VER}"

echo -e "\n${BLUE}[2/8]${NC} Checking for existing VMware installation"
if command -v vmware &> /dev/null; then
    echo -e "      ${YELLOW}⚠${NC} VMware Workstation appears to be installed"
    read -p "      Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}[*] Installation cancelled${NC}"
        exit 0
    fi
fi

echo -e "\n${BLUE}[3/8]${NC} Installing dependencies for $DISTRO_FAMILY"

case "$DISTRO_FAMILY" in
    arch)
        echo -e "      Installing Arch Linux dependencies..."
        
        pacman -Sy --needed --noconfirm \
            base-devel \
            linux-headers \
            dkms \
            libxcrypt-compat \
            git \
            fuse2 \
            gtkmm3 \
            libcanberra \
            pcsclite \
            gcc \
            make
        
        echo -e "\n${BLUE}[4/8]${NC} Building AUR packages"
        
        if detect_aur_helper; then
            echo -e "      Using AUR helper: ${AUR_HELPER}"
            
            sudo -u "$ACTUAL_USER" $AUR_HELPER -S --needed --noconfirm vmware-workstation || {
                echo -e "${RED}[!] AUR helper failed, falling back to manual build${NC}"
                build_aur_manual "vmware-workstation" || {
                    echo -e "${RED}[!] Failed to install VMware Workstation${NC}"
                    exit 1
                }
            }
        else
            install_aur_helper
            
            sudo -u "$ACTUAL_USER" $AUR_HELPER -S --needed --noconfirm vmware-workstation || {
                echo -e "${RED}[!] AUR helper failed, falling back to manual build${NC}"
                build_aur_manual "vmware-workstation" || {
                    echo -e "${RED}[!] Failed to install VMware Workstation${NC}"
                    exit 1
                }
            }
            
            if [[ "$TEMP_AUR_HELPER" == "true" ]]; then
                read -p "      Keep yay installed? (y/N): " -n 1 -r
                echo
                if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                    pacman -Rns --noconfirm yay
                    echo -e "      ${GREEN}✓${NC} yay removed"
                else
                    echo -e "      ${GREEN}✓${NC} yay kept for future use"
                fi
            fi
        fi
        ;;
        
    debian)
        echo -e "      Installing Debian/Ubuntu dependencies..."
        apt-get update
        apt-get install -y \
            build-essential \
            linux-headers-$(uname -r) \
            dkms \
            git \
            gcc \
            make \
            perl \
            libfuse2 \
            libgtkmm-3.0-1v5 \
            libcanberra-gtk3-module \
            pcscd
        
        MANUAL_INSTALL=true
        ;;
        
    fedora)
        echo -e "      Installing Fedora/RHEL dependencies..."
        PKG_MGR=$(command -v dnf &> /dev/null && echo "dnf" || echo "yum")
        
        $PKG_MGR install -y \
            kernel-devel \
            kernel-headers \
            gcc \
            make \
            perl \
            dkms \
            git \
            fuse \
            gtkmm30 \
            libcanberra-gtk3 \
            pcsc-lite
        
        MANUAL_INSTALL=true
        ;;
        
    suse)
        echo -e "      Installing openSUSE dependencies..."
        zypper install -y \
            kernel-devel \
            gcc \
            make \
            perl \
            dkms \
            git \
            fuse \
            gtkmm3 \
            libcanberra-gtk3-0 \
            pcsc-lite
        
        MANUAL_INSTALL=true
        ;;
        
    void)
        echo -e "      Installing Void Linux dependencies..."
        xbps-install -Syu \
            base-devel \
            linux-headers \
            dkms \
            git \
            gcc \
            make \
            fuse \
            gtk+3-devel
        
        MANUAL_INSTALL=true
        ;;
        
    *)
        echo -e "${RED}[!] Unsupported distribution: $DISTRO_FAMILY${NC}"
        exit 1
        ;;
esac

if [[ "$MANUAL_INSTALL" == "true" ]]; then
    echo -e "\n${BLUE}[4/8]${NC} Downloading VMware Workstation"
    
    VMWARE_BUNDLE=$(find /tmp ~/Downloads -name "VMware-Workstation-*.bundle" 2>/dev/null | head -n 1)
    
    if [[ -z "$VMWARE_BUNDLE" ]]; then
        echo -e "      ${YELLOW}⚠${NC} VMware bundle not found"
        echo -e "      Download from: https://www.vmware.com/products/workstation-pro"
        echo -e ""
        read -p "      Path to VMware bundle (or Enter to skip): " VMWARE_BUNDLE
        
        if [[ -z "$VMWARE_BUNDLE" ]] || [[ ! -f "$VMWARE_BUNDLE" ]]; then
            echo -e "${YELLOW}[*] Skipping VMware installation${NC}"
            SKIP_VMWARE_INSTALL=true
        fi
    fi
    
    if [[ "$SKIP_VMWARE_INSTALL" != "true" ]]; then
        echo -e "      Found: $(basename $VMWARE_BUNDLE)"
        chmod +x "$VMWARE_BUNDLE"
        
        echo -e "      Installing VMware Workstation..."
        "$VMWARE_BUNDLE" --console --required --eulas-agreed || {
            echo -e "${RED}[!] VMware installation failed${NC}"
            exit 1
        }
    fi
fi

echo -e "\n${BLUE}[5/8]${NC} Setting up automatic module rebuild"

case "$DISTRO_FAMILY" in
    arch)
        mkdir -p /etc/pacman.d/hooks
        
        cat > /etc/pacman.d/hooks/90-vmware-dkms.hook << 'HOOKEOF'
[Trigger]
Operation = Install
Operation = Upgrade
Type = Package
Target = linux
Target = linux-lts
Target = linux-zen
Target = linux-hardened
Target = vmware-workstation

[Action]
Description = Rebuilding VMware kernel modules
When = PostTransaction
Exec = /usr/bin/dkms autoinstall
HOOKEOF
        echo -e "      ${GREEN}✓${NC} Pacman hook installed"
        ;;
        
    debian)
        mkdir -p /etc/apt/apt.conf.d
        cat > /etc/apt/apt.conf.d/99-vmware-dkms << 'APTEOF'
DPkg::Post-Invoke {
    "if [ -x /usr/sbin/dkms ]; then /usr/sbin/dkms autoinstall --kernelver $(uname -r) 2>/dev/null || true; fi";
};
APTEOF
        echo -e "      ${GREEN}✓${NC} APT hook installed"
        ;;
        
    fedora)
        mkdir -p /etc/dnf/plugins/post-transaction-actions.d
        cat > /etc/dnf/plugins/post-transaction-actions.d/vmware-dkms.action << 'DNFEOF'
kernel*:install,update:/usr/sbin/dkms autoinstall 2>/dev/null || true
DNFEOF
        echo -e "      ${GREEN}✓${NC} DNF hook installed"
        ;;
        
    suse)
        cat > /etc/systemd/system/vmware-dkms-rebuild.service << 'SYSDEOF'
[Unit]
Description=Rebuild VMware DKMS modules
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/usr/sbin/dkms autoinstall

[Install]
WantedBy=multi-user.target
SYSDEOF
        systemctl daemon-reload
        echo -e "      ${GREEN}✓${NC} Systemd service installed"
        ;;
esac

if [[ "$SKIP_VMWARE_INSTALL" != "true" ]]; then
    echo -e "\n${BLUE}[6/8]${NC} Building VMware kernel modules"
    if command -v dkms &> /dev/null; then
        dkms autoinstall 2>&1 | tee /tmp/dkms-build.log || {
            echo -e "      ${YELLOW}⚠${NC} DKMS build warnings (see /tmp/dkms-build.log)"
        }
    fi
else
    echo -e "\n${BLUE}[6/8]${NC} Skipping DKMS build"
fi

echo -e "\n${BLUE}[7/8]${NC} Configuring VMware services"

if [[ "$SKIP_VMWARE_INSTALL" != "true" ]]; then
    VMWARE_SERVICES_DIR=""
    for dir in /usr/lib/systemd/system /lib/systemd/system /etc/systemd/system; do
        if [[ -d "$dir" ]] && ls "$dir"/vmware*.service &> /dev/null; then
            VMWARE_SERVICES_DIR="$dir"
            break
        fi
    done

    if [[ -n "$VMWARE_SERVICES_DIR" ]]; then
        systemctl daemon-reload
        
        for service in vmware-networks vmware-usbarbitrator vmware-hostd; do
            if [[ -f "$VMWARE_SERVICES_DIR/${service}.service" ]]; then
                systemctl enable ${service}.service 2>/dev/null || true
                systemctl start ${service}.service 2>/dev/null || echo -e "      ${YELLOW}⚠${NC} Could not start ${service}"
            fi
        done
    fi
fi

echo -e "\n${BLUE}[8/8]${NC} Loading VMware kernel modules"

if [[ "$SKIP_VMWARE_INSTALL" != "true" ]]; then
    for module in vmw_vmci vmmon vmnet; do
        if modprobe $module 2>/dev/null; then
            echo -e "      ${GREEN}✓${NC} $module loaded"
        else
            echo -e "      ${YELLOW}⚠${NC} $module will load after reboot"
        fi
    done
fi

echo -e "\n${BLUE}[*]${NC} Installation verification"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

ERRORS=0
WARNINGS=0

if [[ "$SKIP_VMWARE_INSTALL" != "true" ]]; then
    for module in vmmon vmw_vmci; do
        if lsmod | grep -q "$module"; then
            echo -e "      ${GREEN}✓${NC} $module kernel module loaded"
        else
            echo -e "      ${YELLOW}⚠${NC} $module not loaded (reboot required)"
            ((WARNINGS++))
        fi
    done

    VMWARE_FOUND=false
    for path in /usr/bin/vmware /usr/local/bin/vmware; do
        if [[ -x "$path" ]]; then
            echo -e "      ${GREEN}✓${NC} VMware binary: $path"
            VMWARE_FOUND=true
            break
        fi
    done

    if [[ "$VMWARE_FOUND" == "false" ]]; then
        echo -e "      ${RED}✗${NC} VMware binary not found"
        ((ERRORS++))
    fi

    for service in vmware-networks vmware-usbarbitrator; do
        if systemctl is-active --quiet ${service}.service 2>/dev/null; then
            echo -e "      ${GREEN}✓${NC} ${service}.service active"
        fi
    done

    if command -v dkms &> /dev/null; then
        if dkms status | grep -q vmware 2>/dev/null; then
            echo -e "      ${GREEN}✓${NC} VMware DKMS modules registered"
        else
            echo -e "      ${YELLOW}⚠${NC} No DKMS modules found"
            ((WARNINGS++))
        fi
    fi
fi

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

if [[ "$SKIP_VMWARE_INSTALL" == "true" ]]; then
    echo -e "${YELLOW}Setup complete - VMware installation skipped${NC}"
    echo -e "\n${BLUE}To install manually:${NC}"
    if [[ "$DISTRO_FAMILY" == "arch" ]]; then
        echo -e "  yay -S vmware-workstation"
    else
        echo -e "  Download: https://www.vmware.com/products/workstation-pro"
        echo -e "  Run: sudo bash VMware-Workstation-*.bundle"
    fi
elif [[ $ERRORS -eq 0 ]]; then
    echo -e "${GREEN}VMware Workstation setup complete${NC}"
    
    if [[ $WARNINGS -gt 0 ]]; then
        echo -e "\n${YELLOW}Note: ${WARNINGS} warning(s) - reboot may be required${NC}"
    fi
    
    echo -e "\n${BLUE}Launch:${NC} vmware"
    echo -e "${BLUE}Auto-rebuild:${NC} Modules rebuild on kernel updates"
else
    echo -e "${RED}Setup completed with ${ERRORS} error(s), ${WARNINGS} warning(s)${NC}"
    echo -e "\n${YELLOW}Troubleshooting:${NC}"
    echo -e "  dkms status"
    echo -e "  sudo modprobe vmmon vmw_vmci"
    echo -e "  sudo dkms autoinstall"
fi

echo ""
