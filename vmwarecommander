#!/usr/bin/env bash

################################################################################
# vmwarecommander
# Version: 0.0.3
# Developer: 0xb0rn3 | oxbv1
# 
# Automates VMware Workstation installation on Arch Linux
# Handles kernel detection, dependencies, and automatic DKMS rebuilds
################################################################################

# Exit on any error
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Banner
echo -e "${BLUE}"
cat << "EOF"
╦  ╦╔╦╗╦ ╦╔═╗╦═╗╔═╗  ╔═╗╔═╗╔╦╗╔╦╗╔═╗╔╗╔╔╦╗╔═╗╦═╗
╚╗╔╝║║║║║║╠═╣╠╦╝║╣   ║  ║ ║║║║║║║╠═╣║║║ ║║║╣ ╠╦╝
 ╚╝ ╩ ╩╚╩╝╩ ╩╩╚═╚═╝  ╚═╝╚═╝╩ ╩╩ ╩╩ ╩╝╚╝═╩╝╚═╝╩╚═
EOF
echo -e "${NC}"
echo -e "${YELLOW}v0.0.3 | 0xb0rn3 | oxbv1${NC}\n"

# Root check
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}[!] Run this script with sudo${NC}"
   exit 1
fi

# Detect the actual user (not root)
ACTUAL_USER=${SUDO_USER:-$USER}
USER_HOME=$(eval echo "~$ACTUAL_USER")

# Check for internet connection
echo -e "${BLUE}[*] Checking prerequisites${NC}"
if ! ping -c 1 archlinux.org &> /dev/null; then
    echo -e "${RED}[!] No internet connection detected${NC}"
    exit 1
fi
echo -e "      ${GREEN}✓${NC} Internet connection active"

# Check if running on Arch Linux
if [[ ! -f /etc/arch-release ]]; then
    echo -e "${RED}[!] This script is designed for Arch Linux only${NC}"
    exit 1
fi
echo -e "      ${GREEN}✓${NC} Arch Linux detected"

echo -e "\n${GREEN}[*] Starting VMware Workstation setup${NC}\n"

# Step 1: Kernel detection
echo -e "${BLUE}[1/8]${NC} Detecting kernel type"
KERNEL_VER=$(uname -r)
if [[ "$KERNEL_VER" == *"lts"* ]]; then
    HEADERS_PKG="linux-lts-headers"
    echo -e "      Kernel: LTS (${KERNEL_VER})"
elif [[ "$KERNEL_VER" == *"zen"* ]]; then
    HEADERS_PKG="linux-zen-headers"
    echo -e "      Kernel: Zen (${KERNEL_VER})"
elif [[ "$KERNEL_VER" == *"hardened"* ]]; then
    HEADERS_PKG="linux-hardened-headers"
    echo -e "      Kernel: Hardened (${KERNEL_VER})"
else
    HEADERS_PKG="linux-headers"
    echo -e "      Kernel: Standard (${KERNEL_VER})"
fi

# Step 2: Check for existing VMware installation
echo -e "\n${BLUE}[2/8]${NC} Checking for existing VMware installation"
if pacman -Qi vmware-workstation &> /dev/null; then
    echo -e "      ${YELLOW}⚠${NC} VMware Workstation is already installed"
    read -p "      Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}[*] Installation cancelled${NC}"
        exit 0
    fi
fi

# Step 3: System update and base dependencies
echo -e "\n${BLUE}[3/8]${NC} Installing base dependencies"
pacman -Syu --needed --noconfirm \
    base-devel \
    "$HEADERS_PKG" \
    dkms \
    libxcrypt-compat \
    libxml2 \
    git \
    fuse2 \
    gtkmm3 \
    libcanberra \
    pcsclite

# Step 4: AUR package builder function
build_aur_package() {
    local PKG_NAME=$1
    
    if pacman -Qi "$PKG_NAME" &> /dev/null; then
        echo -e "      ${PKG_NAME} is already installed"
        return 0
    fi
    
    echo -e "      Building ${PKG_NAME} from AUR"
    
    local BUILD_DIR="/tmp/aur-${PKG_NAME}-$$"
    mkdir -p "$BUILD_DIR"
    cd "$BUILD_DIR"
    
    # Clone with error handling
    if ! sudo -u "$ACTUAL_USER" git clone "https://aur.archlinux.org/${PKG_NAME}.git" . 2>/dev/null; then
        echo -e "      ${RED}✗${NC} Failed to clone ${PKG_NAME} from AUR"
        cd /
        rm -rf "$BUILD_DIR"
        return 1
    fi
    
    # Build with error handling
    if ! sudo -u "$ACTUAL_USER" makepkg -si --noconfirm; then
        echo -e "      ${RED}✗${NC} Failed to build ${PKG_NAME}"
        cd /
        rm -rf "$BUILD_DIR"
        return 1
    fi
    
    cd /
    rm -rf "$BUILD_DIR"
    return 0
}

# Step 5: Build AUR dependencies
echo -e "\n${BLUE}[4/8]${NC} Building AUR packages"
if ! build_aur_package "vmware-keymaps"; then
    echo -e "${RED}[!] Failed to install vmware-keymaps${NC}"
    exit 1
fi

if ! build_aur_package "vmware-workstation"; then
    echo -e "${RED}[!] Failed to install vmware-workstation${NC}"
    exit 1
fi

# Step 6: Pacman hook creation
echo -e "\n${BLUE}[5/8]${NC} Creating Pacman hook for automatic DKMS rebuilds"
mkdir -p /etc/pacman.d/hooks

# Backup existing hook if present
if [[ -f /etc/pacman.d/hooks/90-vmware-dkms.hook ]]; then
    cp /etc/pacman.d/hooks/90-vmware-dkms.hook \
       /etc/pacman.d/hooks/90-vmware-dkms.hook.backup.$(date +%s)
    echo -e "      Backed up existing hook"
fi

cat > /etc/pacman.d/hooks/90-vmware-dkms.hook << 'HOOKEOF'
[Trigger]
Operation = Install
Operation = Upgrade
Type = Package
Target = linux
Target = linux-lts
Target = linux-zen
Target = linux-hardened
Target = vmware-workstation

[Action]
Description = Rebuilding VMware kernel modules
When = PostTransaction
Exec = /usr/bin/dkms autoinstall
HOOKEOF

echo -e "      ${GREEN}✓${NC} Hook installed at /etc/pacman.d/hooks/90-vmware-dkms.hook"

# Step 7: Initial DKMS build
echo -e "\n${BLUE}[6/8]${NC} Building VMware kernel modules with DKMS"
if dkms status | grep -q vmware; then
    echo -e "      Running DKMS autoinstall..."
    dkms autoinstall || echo -e "      ${YELLOW}⚠${NC} DKMS autoinstall reported warnings (may be normal)"
else
    echo -e "      ${YELLOW}⚠${NC} No VMware DKMS modules found to build"
fi

# Step 8: Service configuration
echo -e "\n${BLUE}[7/8]${NC} Configuring VMware services"
systemctl enable vmware-networks.service 2>/dev/null || true
systemctl enable vmware-usbarbitrator.service 2>/dev/null || true

# Start services
systemctl start vmware-networks.service 2>/dev/null || echo -e "      ${YELLOW}⚠${NC} Could not start vmware-networks.service"
systemctl start vmware-usbarbitrator.service 2>/dev/null || echo -e "      ${YELLOW}⚠${NC} Could not start vmware-usbarbitrator.service"

# Step 9: Load kernel modules
echo -e "\n${BLUE}[8/8]${NC} Loading VMware kernel modules"
if modprobe vmw_vmci 2>/dev/null; then
    echo -e "      ${GREEN}✓${NC} vmw_vmci loaded"
else
    echo -e "      ${RED}✗${NC} Failed to load vmw_vmci"
fi

if modprobe vmmon 2>/dev/null; then
    echo -e "      ${GREEN}✓${NC} vmmon loaded"
else
    echo -e "      ${RED}✗${NC} Failed to load vmmon"
fi

# Final verification
echo -e "\n${BLUE}[*]${NC} Installation verification"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

ERRORS=0

# Check modules
if lsmod | grep -q "vmmon"; then
    echo -e "      ${GREEN}✓${NC} vmmon kernel module loaded"
else
    echo -e "      ${RED}✗${NC} vmmon kernel module NOT loaded"
    ((ERRORS++))
fi

if lsmod | grep -q "vmw_vmci"; then
    echo -e "      ${GREEN}✓${NC} vmw_vmci kernel module loaded"
else
    echo -e "      ${RED}✗${NC} vmw_vmci kernel module NOT loaded"
    ((ERRORS++))
fi

# Check services
if systemctl is-active --quiet vmware-networks.service; then
    echo -e "      ${GREEN}✓${NC} vmware-networks.service active"
else
    echo -e "      ${YELLOW}⚠${NC} vmware-networks.service inactive"
fi

if systemctl is-active --quiet vmware-usbarbitrator.service; then
    echo -e "      ${GREEN}✓${NC} vmware-usbarbitrator.service active"
else
    echo -e "      ${YELLOW}⚠${NC} vmware-usbarbitrator.service inactive"
fi

# Check binary
if command -v vmware &> /dev/null; then
    echo -e "      ${GREEN}✓${NC} vmware binary found"
else
    echo -e "      ${RED}✗${NC} vmware binary NOT found"
    ((ERRORS++))
fi

# Check hook
if [[ -f /etc/pacman.d/hooks/90-vmware-dkms.hook ]]; then
    if grep -q "Type = Package" /etc/pacman.d/hooks/90-vmware-dkms.hook; then
        echo -e "      ${GREEN}✓${NC} Pacman hook properly configured"
    else
        echo -e "      ${RED}✗${NC} Pacman hook missing Type field"
        ((ERRORS++))
    fi
else
    echo -e "      ${RED}✗${NC} Pacman hook NOT found"
    ((ERRORS++))
fi

# Completion
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

if [[ $ERRORS -eq 0 ]]; then
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}VMware Workstation setup complete - No errors!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "\n${BLUE}Launch VMware:${NC} vmware"
    echo -e "${BLUE}First run:${NC} You may need to accept the EULA and enter a license key"
    echo -e "${BLUE}Auto-rebuild:${NC} Kernel modules will rebuild automatically on kernel updates"
else
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${YELLOW}VMware Workstation setup completed with ${ERRORS} error(s)${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "\n${YELLOW}Troubleshooting:${NC}"
    echo -e "  1. Check DKMS status: ${BLUE}sudo dkms status${NC}"
    echo -e "  2. Manually load modules: ${BLUE}sudo modprobe -a vmw_vmci vmmon${NC}"
    echo -e "  3. Check system logs: ${BLUE}journalctl -xe${NC}"
fi

echo ""
